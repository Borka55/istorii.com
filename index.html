<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Сайт с историями</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .story-container {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .story-title {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .story-text {
            line-height: 1.6;
            color: #444;
        }
        .nav-menu {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .nav-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px;
        }
        .nav-menu a {
            color: white;
            text-decoration: none;
            font-size: 18px;
            transition: color 0.3s;
        }
        .nav-menu a:hover {
            color: #ffd700;
        }
        .story-form {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .story-form h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #444;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-group textarea {
            height: 200px;
            resize: vertical;
        }
        .submit-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .submit-button:hover {
            background-color: #45a049;
        }
        .story-author {
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .story-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .like-button, .share-button {
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .like-button.liked {
            background-color: #ff3333;
            opacity: 0.8;
        }
        
        .like-button[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .like-button:hover:not([disabled]) {
            background-color: #ff3333;
        }
        
        .share-button {
            background-color: #4d79ff;
            color: white;
        }
        
        .share-button:hover {
            background-color: #3366ff;
        }
        
        .stories-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .message {
            padding: 10px 20px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        
        .error-message {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        
        .form-group .error {
            color: #a94442;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .search-container {
            margin: 20px 0;
            position: relative;
        }
        
        #searchInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #searchInput:focus {
            border-color: #4CAF50;
            box-shadow: 0 2px 8px rgba(76,175,80,0.2);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .story-container.hidden {
            display: none;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
            display: none;
        }
        .auth-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
            display: none;
        }
        
        .auth-container.active {
            display: block;
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .auth-info {
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .auth-info.active {
            display: flex;
        }
        
        .logout-button {
            background-color: #ff4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .user-name {
            font-weight: bold;
            color: #333;
        }
        
        #myStoriesBtn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #myStoriesBtn:hover {
            background-color: #45a049;
        }
        
        .nav-button.active {
            background-color: #45a049;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .no-stories-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            color: #666;
        }

        .toggle-password:hover {
            color: #333;
        }

        .password-container input {
            width: 100%;
            padding-right: 35px;
        }

        #likedStoriesBtn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #likedStoriesBtn:hover {
            background-color: #45a049;
        }
        
        #likedStoriesBtn.active {
            background-color: #45a049;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .like-button {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .like-button.liked {
            background-color: #ffe6e6;
            border-color: #ffcccc;
            color: #ff4444;
        }
        
        .like-button:hover {
            transform: scale(1.05);
            background-color: #f0f0f0;
        }
        
        .like-button.liked:hover {
            background-color: #ffd9d9;
        }

        .nav-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-button:hover {
            background-color: #45a049;
        }

        .auth-prompt {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px;
            background-color: #f8f8f8;
            border-radius: 4px;
            text-align: center;
        }
        
        .story-likes {
            color: #666;
            margin-left: 10px;
        }
        
        .story-container {
            position: relative;
            padding: 20px;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .story-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .story-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            color: #666;
            font-size: 0.9em;
        }

        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .share-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            max-width: 400px;
            width: 90%;
        }
        
        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .share-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            text-decoration: none;
            color: white;
            transition: background-color 0.3s;
        }
        
        .share-button.vk {
            background-color: #4a76a8;
        }
        
        .share-button.telegram {
            background-color: #0088cc;
        }
        
        .share-button.copy {
            background-color: #6c757d;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .story-actions .share-button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .story-actions .share-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <nav class="nav-menu">
        <ul>
            <li><button id="myStoriesBtn" onclick="showMyStories()" style="display: none;">Мои истории</button></li>
            <li><button id="likedStoriesBtn" onclick="showLikedStories()" style="display: none;">Понравившиеся</button></li>
            <li class="auth-buttons" id="authButtons">
                <button onclick="showAuthForm('login')">Войти</button>
                <button onclick="showAuthForm('register')">Регистрация</button>
            </li>
            <li class="auth-info" id="authInfo">
                <span class="user-name" id="userName"></span>
                <button class="logout-button" onclick="logout()">Выйти</button>
            </li>
        </ul>
    </nav>
    
    <h1>Добро пожаловать в мир историй</h1>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Поиск по названию, автору или тексту истории...">
        <span class="search-icon">🔍</span>
    </div>
    
    <div id="noResults" class="no-results">
        Истории не найдены
    </div>

    <!-- Добавляем контейнер для историй -->
    <div class="stories-container">
        <!-- Существующие истории -->
        <div class="story-container">
            <h2 class="story-title">История 1</h2>
            <div class="story-text">
                В один прекрасный день в маленьком городке случилось нечто необычное. 
                Все жители проснулись и обнаружили, что их дома окрасились в разные цвета радуги. 
                Никто не знал, как это произошло, но этот день навсегда изменил жизнь горожан...
            </div>
        </div>

        <div class="story-container">
            <h2 class="story-title">История 2</h2>
            <div class="story-text">
                На окраине леса жил старый мудрец, который знал язык животных. 
                Каждое утро к нему приходили лесные жители и рассказывали свои истории. 
                Однажды произошло что-то совершенно удивительное...
            </div>
        </div>
    </div>

    <div class="story-form">
        <h2>Добавить новую историю</h2>
        <div id="successMessage" class="message success-message">История успешно добавлена!</div>
        <div id="errorMessage" class="message error-message"></div>
        <form id="newStoryForm">
            <div class="form-group">
                <label for="storyTitle">Название истории:</label>
                <input type="text" id="storyTitle" name="storyTitle" required>
                <div class="error" id="titleError"></div>
            </div>
            
            <div class="form-group">
                <label for="storyText">Текст истории:</label>
                <textarea id="storyText" name="storyText" required></textarea>
                <div class="error" id="textError"></div>
            </div>
            
            <button type="submit" class="submit-button">Опубликовать историю</button>
        </form>
    </div>

    <div class="auth-container" id="authContainer">
        <h2 id="authTitle">Вход</h2>
        <form id="authForm">
            <div class="form-group">
                <label for="username">Имя пользователя:</label>
                <input type="text" id="username" name="username" required>
                <div class="error" id="usernameError"></div>
            </div>
            
            <div class="form-group">
                <label for="password">Пароль:</label>
                <div class="password-container">
                    <input type="password" id="password" name="password" required>
                    <button type="button" class="toggle-password" onclick="togglePassword()">👁️</button>
                </div>
                <div class="error" id="passwordError"></div>
            </div>
            
            <button type="submit" class="submit-button">Войти</button>
        </form>
    </div>

    <script>
        function validateStory(data) {
            const sanitizeInput = (input) => {
                return input
                    .replace(/[&<>"']/g, char => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    })[char]);
            };
            
            let isValid = true;
            const errors = {};
            
            // Валидация названия
            if (!data.storyTitle || data.storyTitle.trim().length < 3) {
                errors.title = 'Название должно содержать минимум 3 символа';
                isValid = false;
            } else if (data.storyTitle.length > 100) {
                errors.title = 'Название не должно превышать 100 символов';
                isValid = false;
            }
            
            // Валидация текста истории
            if (!data.storyText || data.storyText.trim().length < 10) {
                errors.text = 'История должна содержать минимум 10 символов';
                isValid = false;
            } else if (data.storyText.length > 5000) {
                errors.text = 'История не должна превышать 5000 символов';
                isValid = false;
            }
            
            // Санитизация данных
            if (isValid) {
                data.storyTitle = sanitizeInput(data.storyTitle);
                data.storyText = sanitizeInput(data.storyText);
            }
            
            return { isValid, errors };
        }

        function showError(field, message) {
            try {
                const errorElement = document.getElementById(`${field}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                    
                    // Подсвечиваем поле с ошибкой
                    const inputElement = document.getElementById(field);
                    if (inputElement) {
                        inputElement.classList.add('error');
                        // Убираем подсветку через 3 секунды
                        setTimeout(() => {
                            inputElement.classList.remove('error');
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Ошибка при отображении ошибки поля:', error);
            }
        }

        function clearErrors() {
            try {
                // Очищаем сообщения об ошибках
                const errorElements = document.querySelectorAll('.error-message');
                errorElements.forEach(element => {
                    element.textContent = '';
                    element.style.display = 'none';
                });
                
                // Убираем подсветку полей с ошибками
                const inputElements = document.querySelectorAll('.error');
                inputElements.forEach(element => {
                    element.classList.remove('error');
                });
            } catch (error) {
                console.error('Ошибка при очистке ошибок:', error);
            }
        }

        function showMessage(type, message, duration = 3000) {
            try {
                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) return;
                
                // Создаем элемент сообщения
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}-message`;
                messageElement.textContent = message;
                
                // Добавляем сообщение
                messageContainer.appendChild(messageElement);
                
                // Анимация появления
                setTimeout(() => {
                    messageElement.classList.add('show');
                }, 100);
                
                // Удаляем сообщение через указанное время
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    setTimeout(() => {
                        messageContainer.removeChild(messageElement);
                    }, 300);
                }, duration);
                
            } catch (error) {
                console.error('Ошибка при показе сообщения:', error);
            }
        }

        // Функция проверки режима браузера и доступности хранилища
        function checkBrowserMode() {
            try {
                // Проверяем доступность localStorage
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                
                // Проверяем размер доступного хранилища
                let size = 0;
                const testData = 'x'.repeat(1024 * 1024); // 1MB данных
                try {
                    for (let i = 0; size < 10; i++) {
                        localStorage.setItem(`test${i}`, testData);
                        size++;
                    }
                } catch (e) {
                    // Достигнут лимит хранилища
                } finally {
                    // Очищаем тестовые данные
                    for (let i = 0; i < size; i++) {
                        localStorage.removeItem(`test${i}`);
                    }
                }
                
                return {
                    isAvailable: true,
                    isPrivateMode: size < 5, // Если доступно менее 5MB, вероятно это приватный режим
                    storageSize: size
                };
            } catch (e) {
                return {
                    isAvailable: false,
                    isPrivateMode: true,
                    storageSize: 0
                };
            }
        }

        // Функция инициализации приложения с учетом режима браузера
        function initializeWithBrowserMode() {
            const browserMode = checkBrowserMode();
            
            if (!browserMode.isAvailable) {
                showBrowserModeWarning('storage-unavailable');
                return false;
            }
            
            if (browserMode.isPrivateMode) {
                showBrowserModeWarning('private-mode');
                // Продолжаем работу, но с ограничениями
                return true;
            }
            
            return true;
        }

        // Функция отображения предупреждений о режиме браузера
        function showBrowserModeWarning(type) {
            const warningContainer = document.createElement('div');
            warningContainer.className = 'browser-mode-warning';
            
            switch (type) {
                case 'storage-unavailable':
                    warningContainer.innerHTML = `
                        <div class="warning-message">
                            <h3>⚠️ Внимание: Хранилище недоступно</h3>
                            <p>Приложение не может работать без доступа к локальному хранилищу. Возможные причины:</p>
                            <ul>
                                <li>Вы используете приватный режим браузера</li>
                                <li>В браузере отключено локальное хранилище</li>
                                <li>Недостаточно места в хранилище</li>
                            </ul>
                            <p>Рекомендации:</p>
                            <ul>
                                <li>Используйте обычный режим браузера</li>
                                <li>Очистите кэш и данные браузера</li>
                                <li>Попробуйте другой браузер</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'private-mode':
                    warningContainer.innerHTML = `
                        <div class="warning-message">
                            <h3>ℹ️ Приватный режим</h3>
                            <p>Вы используете приватный режим браузера. Это означает:</p>
                            <ul>
                                <li>Данные могут быть утеряны при закрытии вкладки</li>
                                <li>Некоторые функции могут быть недоступны</li>
                                <li>Авторизация будет сброшена при закрытии браузера</li>
                            </ul>
                            <p>Для полной функциональности используйте обычный режим.</p>
                        </div>
                    `;
                    break;
            }
            
            document.body.insertBefore(warningContainer, document.body.firstChild);
        }

        // Функция для работы с хранилищем с учетом режима браузера
        function safeStorage(operation, key, data = null) {
            try {
                switch (operation) {
                    case 'get':
                        const item = localStorage.getItem(key);
                        if (!item) return null;
                        try {
                            return JSON.parse(item);
                        } catch (e) {
                            console.error('Invalid JSON in storage:', e);
                            return null;
                        }
                        
                    case 'set':
                        if (data === null) return false;
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                        
                    case 'remove':
                        localStorage.removeItem(key);
                        return true;
                        
                    case 'clear':
                        localStorage.clear();
                        return true;
                        
                    default:
                        throw new Error('Неизвестная операция с хранилищем');
                }
            } catch (error) {
                console.error(`Ошибка при работе с хранилищем (${operation}):`, error);
                showMessage('error', 'Ошибка при работе с данными');
                return null;
            }
        }

        // Обновляем основные функции для работы с данными
        function getStoriesFromLocalStorage() {
            return safeStorage('get', 'stories') || [];
        }

        function saveStoriesToLocalStorage(stories) {
            return safeStorage('set', 'stories', stories);
        }

        function getCurrentUser() {
            return safeStorage('get', 'currentUser');
        }

        function setCurrentUser(user) {
            return safeStorage('set', 'currentUser', user);
        }

        // Инициализация приложения с проверкой режима браузера
        document.addEventListener('DOMContentLoaded', () => {
            if (initializeWithBrowserMode()) {
                // Инициализируем приложение
                initializeApp();
            }
        });

        // Функция инициализации данных приложения
        function initializeApp() {
            try {
                console.log('Инициализация приложения...');
                
                // Проверяем и инициализируем хранилище
                if (!localStorage.getItem('stories')) {
                    // Добавляем тестовую историю, если историй нет
                    const initialStories = [{
                        id: 'welcome-story',
                        title: 'Добро пожаловать!',
                        text: 'Это первая история в нашем приложении. Здесь вы можете делиться своими историями и читать истории других людей.',
                        authorName: 'Администратор',
                        date: new Date().toISOString(),
                        likes: 0,
                        likedBy: []
                    }];
                    localStorage.setItem('stories', JSON.stringify(initialStories));
                }
                
                // Остальная инициализация
                updateAuthUI();
                displayStories();
                setupEventListeners();
                
                return true;
            } catch (error) {
                console.error('Ошибка при инициализации:', error);
                return false;
            }
        }

        // Функция настройки обработчиков событий
        function setupEventListeners() {
            // Форма авторизации
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', handleAuthSubmit);
            }
            
            // Форма добавления истории
            const storyForm = document.getElementById('newStoryForm');
            if (storyForm) {
                storyForm.addEventListener('submit', handleStorySubmit);
            }
            
            // Поиск историй
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => {
                    if (e && e.target) {
                        searchStories(e.target.value);
                    }
                }, 300));
                
                // Очистка поиска по Escape
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        searchStories('');
                    }
                });
            }
            
            // Кнопки навигации
            const myStoriesBtn = document.getElementById('myStoriesBtn');
            if (myStoriesBtn) {
                myStoriesBtn.addEventListener('click', showMyStories);
            }
            
            const likedStoriesBtn = document.getElementById('likedStoriesBtn');
            if (likedStoriesBtn) {
                likedStoriesBtn.addEventListener('click', showLikedStories);
            }
            
            // Кнопка выхода
            const logoutButton = document.querySelector('.logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }
        }

        // Функция инициализации UI
        function initializeUI() {
            // Обновляем состояние авторизации
            updateAuthUI();
            
            // Отображаем истории
            displayStories();
            
            // Проверяем и обновляем состояние поиска
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value) {
                searchStories(searchInput.value);
            }
            
            // Показываем сообщение о готовности приложения
            showMessage('success', 'Приложение готово к работе');
        }

        // Функция отключения функционала приложения
        function disableAppFunctionality() {
            const elements = {
                storyForm: document.querySelector('.story-form'),
                authButtons: document.querySelector('.auth-buttons'),
                storiesContainer: document.querySelector('.stories-container')
            };
            
            // Отключаем формы и кнопки
            if (elements.storyForm) {
                elements.storyForm.style.display = 'none';
            }
            
            if (elements.authButtons) {
                elements.authButtons.style.display = 'none';
            }
            
            // Показываем сообщение об ошибке в контейнере историй
            if (elements.storiesContainer) {
                elements.storiesContainer.innerHTML = `
                    <div class="error-message">
                        <h3>Приложение недоступно</h3>
                        <p>Локальное хранилище недоступно. Попробуйте:</p>
                        <ul>
                            <li>Использовать обычный режим браузера</li>
                            <li>Очистить кэш браузера</li>
                            <li>Использовать другой браузер</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Обновляем функцию управления UI
        function updateAuthUI() {
            try {
                const currentUser = getCurrentUser();
                const elements = {
                    // Элементы авторизации
                    authButtons: document.querySelector('.auth-buttons'),
                    authInfo: document.querySelector('.auth-info'),
                    authContainer: document.getElementById('authContainer'),
                    userName: document.getElementById('userName'),
                    
                    // Формы
                    storyForm: document.querySelector('.story-form'),
                    newStoryForm: document.getElementById('newStoryForm'),
                    
                    // Навигация
                    myStoriesBtn: document.getElementById('myStoriesBtn'),
                    likedStoriesBtn: document.getElementById('likedStoriesBtn'),
                    
                    // Контейнеры
                    storiesContainer: document.querySelector('.stories-container'),
                    searchContainer: document.querySelector('.search-container')
                };
                
                // Проверяем наличие основных элементов
                if (!elements.authButtons || !elements.authInfo) {
                    console.error('Не найдены основные элементы интерфейса');
                    return;
                }
                
                if (currentUser) {
                    // Пользователь авторизован
                    // Элементы авторизации
                    elements.authButtons.style.display = 'none';
                    elements.authInfo.style.display = 'flex';
                    if (elements.authContainer) {
                        elements.authContainer.classList.remove('active');
                    }
                    
                    // Имя пользователя
                    if (elements.userName) {
                        elements.userName.textContent = currentUser.username;
                    }
                    
                    // Формы
                    if (elements.storyForm) {
                        elements.storyForm.style.display = 'block';
                    }
                    if (elements.newStoryForm) {
                        elements.newStoryForm.style.display = 'block';
                    }
                    
                    // Навигация
                    if (elements.myStoriesBtn) {
                        elements.myStoriesBtn.style.display = 'block';
                    }
                    if (elements.likedStoriesBtn) {
                        elements.likedStoriesBtn.style.display = 'block';
                    }
                    
                    // Поиск
                    if (elements.searchContainer) {
                        elements.searchContainer.style.display = 'block';
                    }
                    
                } else {
                    // Пользователь не авторизован
                    // Элементы авторизации
                    elements.authButtons.style.display = 'flex';
                    elements.authInfo.style.display = 'none';
                    
                    // Очищаем имя пользователя
                    if (elements.userName) {
                        elements.userName.textContent = '';
                    }
                    
                    // Скрываем формы
                    if (elements.storyForm) {
                        elements.storyForm.style.display = 'none';
                    }
                    if (elements.newStoryForm) {
                        elements.newStoryForm.style.display = 'none';
                    }
                    
                    // Скрываем навигацию
                    if (elements.myStoriesBtn) {
                        elements.myStoriesBtn.style.display = 'none';
                    }
                    if (elements.likedStoriesBtn) {
                        elements.likedStoriesBtn.style.display = 'none';
                    }
                }
                
                // Обновляем отображение историй
                displayStories();
                
            } catch (error) {
                console.error('Ошибка при обновлении интерфейса:', error);
                showMessage('error', 'Произошла ошибка при обновлении интерфейса');
            }
        }

        // Функция переключения видимости элемента
        function toggleElement(element, show) {
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        // Функция показа/скрытия формы авторизации
        function toggleAuthForm(type) {
            const authContainer = document.getElementById('authContainer');
            const authForm = document.getElementById('authForm');
            const authTitle = document.querySelector('.auth-title');
            
            if (!authContainer || !authForm || !authTitle) {
                console.error('Не найдены элементы формы авторизации');
                return;
            }
            
            // Очищаем ошибки и форму
            clearErrors();
            authForm.reset();
            
            // Устанавливаем тип формы
            authForm.dataset.type = type;
            
            // Обновляем заголовок
            authTitle.textContent = type === 'register' ? 'Регистрация' : 'Вход';
            
            // Показываем форму
            authContainer.classList.add('active');
        }

        // Функция скрытия формы авторизации
        function hideAuthForm() {
            const authContainer = document.getElementById('authContainer');
            if (authContainer) {
                authContainer.classList.remove('active');
            }
        }

        // Обработчик клика вне формы авторизации
        document.addEventListener('click', (e) => {
            const authContainer = document.getElementById('authContainer');
            if (authContainer && e.target === authContainer) {
                hideAuthForm();
            }
        });

        // Добавляем функцию для отображения понравившихся историй
        function showLikedStories() {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showMessage('error', 'Необходимо войти в систему');
                return;
            }
            
            // Обновляем активное состояние кнопок
            const allButtons = document.querySelectorAll('.nav-menu button');
            allButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('likedStoriesBtn').classList.add('active');
            
            // Фильтруем и отображаем только понравившиеся истории
            displayStories(story => story.likedBy && story.likedBy.includes(currentUser.username));
            
            const stories = document.querySelectorAll('.story-container');
            if (stories.length === 0) {
                document.querySelector('.stories-container').innerHTML = `
                    <div class="no-stories-message">
                        У вас пока нет понравившихся историй
                    </div>
                `;
            }
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = '👁️‍🗨️';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = '👁️';
            }
        }

        // Обновляем функцию handleStorySubmit
        async function handleStorySubmit(e) {
            e.preventDefault();
            clearErrors();
            
            try {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    showMessage('error', 'Необходимо войти в систему');
                    return;
                }
                
                const formData = new FormData(e.target);
                const storyData = {
                    id: crypto.randomUUID(), // Убедимся, что ID генерируется
                    title: formData.get('storyTitle')?.trim(),
                    text: formData.get('storyText')?.trim(),
                    authorName: currentUser.username,
                    date: new Date().toISOString(),
                    likes: 0, // Инициализируем счетчик лайков
                    likedBy: [] // Инициализируем массив пользователей
                };
                
                const { isValid, errors } = validateStory(storyData);
                
                if (!isValid) {
                    Object.keys(errors).forEach(key => {
                        showError(key, errors[key]);
                    });
                    return;
                }
                
                const stories = JSON.parse(localStorage.getItem('stories') || '[]');
                stories.unshift(storyData);
                localStorage.setItem('stories', JSON.stringify(stories));
                
                e.target.reset();
                displayStories();
                showMessage('success', 'История успешно добавлена!');
                
            } catch (error) {
                console.error('Ошибка при добавлении истории:', error);
                showMessage('error', 'Произошла ошибка при добавлении истории');
            }
        }

        // Обновляем функцию handleLike
        function handleLike(button, storyId) {
            console.log('handleLike вызван:', { button, storyId }); // Отладка
            
            try {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    showMessage('error', 'Необходимо войти в систему для оценки историй');
                    return;
                }
                
                const stories = JSON.parse(localStorage.getItem('stories') || '[]');
                const storyIndex = stories.findIndex(s => s.id === storyId);
                
                if (storyIndex === -1) {
                    console.error('История не найдена:', storyId);
                    return;
                }
                
                const story = stories[storyIndex];
                
                // Инициализируем поля, если они отсутствуют
                if (!Array.isArray(story.likedBy)) {
                    story.likedBy = [];
                }
                if (typeof story.likes !== 'number') {
                    story.likes = 0;
                }
                
                const hasLiked = story.likedBy.includes(currentUser.username);
                console.log('Текущее состояние лайка:', { hasLiked, likedBy: story.likedBy }); // Отладка
                
                if (hasLiked) {
                    story.likedBy = story.likedBy.filter(username => username !== currentUser.username);
                    story.likes = Math.max(0, story.likes - 1);
                } else {
                    story.likedBy.push(currentUser.username);
                    story.likes += 1;
                }
                
                // Обновляем localStorage
                localStorage.setItem('stories', JSON.stringify(stories));
                console.log('Обновленные истории:', stories); // Отладка
                
                // Обновляем отображение
                displayStories();
                
            } catch (error) {
                console.error('Ошибка при обработке лайка:', error);
                showMessage('error', 'Произошла ошибка при обработке лайка');
            }
        }

        // Обновляем функцию displayStories
        function displayStories(filterFn = null) {
            try {
                const storiesContainer = document.querySelector('.stories-container');
                if (!storiesContainer) {
                    console.error('Контейнер историй не найден');
                    return;
                }
                
                let stories = JSON.parse(localStorage.getItem('stories') || '[]');
                console.log('Загруженные истории:', stories); // Отладка
                
                const currentUser = getCurrentUser();
                
                // Применяем фильтр, если он есть
                if (filterFn) {
                    stories = stories.filter(filterFn);
                }
                
                // Если нет историй, показываем сообщение
                if (stories.length === 0) {
                    storiesContainer.innerHTML = `
                        <div class="no-stories-message">
                            Пока нет историй
                        </div>
                    `;
                    return;
                }
                
                // Формируем HTML для каждой истории
                const storiesHTML = stories.map(story => {
                    const hasLiked = currentUser && story.likedBy && story.likedBy.includes(currentUser.username);
                    const isAuthor = currentUser && story.authorName === currentUser.username;
                    
                    return `
                        <div class="story-container" data-id="${story.id}">
                            <h3 class="story-title">${escapeHtml(story.title)}</h3>
                            <p class="story-text">${escapeHtml(story.text)}</p>
                            <div class="story-meta">
                                <span class="story-author">Автор: ${escapeHtml(story.authorName || 'Аноним')}</span>
                                <span class="story-date">${formatDate(story.date)}</span>
                                <span class="story-likes">👥 ${story.likes || 0}</span>
                            </div>
                            <div class="story-actions">
                                <button 
                                    type="button"
                                    class="share-button"
                                    onclick="shareStory(this, '${story.id}')"
                                >
                                    🔗 Поделиться
                                </button>
                                ${currentUser ? `
                                    <button 
                                        type="button"
                                        class="like-button ${hasLiked ? 'liked' : ''}"
                                        onclick="handleLike(this, '${story.id}')"
                                        data-story-id="${story.id}"
                                    >
                                        ${hasLiked ? '❤️' : '🤍'} ${story.likes || 0}
                                    </button>
                                    ${isAuthor ? `
                                        <button 
                                            type="button"
                                            class="delete-button"
                                            onclick="deleteStory('${story.id}')"
                                        >
                                            🗑️
                                        </button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                storiesContainer.innerHTML = storiesHTML;
                
                // Добавляем обработчики событий для кнопок
                const likeButtons = storiesContainer.querySelectorAll('.like-button');
                likeButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const storyId = this.dataset.storyId;
                        handleLike(this, storyId);
                    });
                });
                
            } catch (error) {
                console.error('Ошибка при отображении историй:', error);
                showMessage('error', 'Произошла ошибка при отображении историй');
            }
        }

        function searchStories(query) {
            const stories = document.querySelectorAll('.story-container');
            const noResults = document.getElementById('noResults');
            let hasVisibleStories = false;
            
            stories.forEach(story => {
                const title = story.querySelector('.story-title').textContent.toLowerCase();
                const text = story.querySelector('.story-text').textContent.toLowerCase();
                const author = story.querySelector('.story-author')?.textContent.toLowerCase() || '';
                
                const searchQuery = query.toLowerCase();
                
                if (title.includes(searchQuery) || 
                    text.includes(searchQuery) || 
                    author.includes(searchQuery)) {
                    story.classList.remove('hidden');
                    hasVisibleStories = true;
                } else {
                    story.classList.add('hidden');
                }
            });
            
            noResults.style.display = hasVisibleStories ? 'none' : 'block';
        }

        // Добавляем обработчик события с debounce
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', debounce((e) => {
                if (e && e.target) {
                    searchStories(e.target.value);
                }
            }, 300));
        }

        // Добавляем обработчик для очистки поиска
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                searchStories('');
            }
        });

        // Обновляем функцию обработки регистрации
        function handleRegistration(username, password) {
            const users = getUsers();
            
            if (users.some(u => u.username === username)) {
                showError('username', 'Пользователь с таким именем уже существует');
                return;
            }
            
            if (password.length < 6) {
                showError('password', 'Пароль должен содержать минимум 6 символов');
                return;
            }
            
            const newUser = { 
                username, 
                password,
                registrationDate: new Date().toISOString()
            };
            
            users.push(newUser);
            
            if (saveUsers(users)) {
                setCurrentUser(newUser);
                showMessage('success', 'Регистрация успешна!');
                const authContainer = document.getElementById('authContainer');
                if (authContainer) {
                    authContainer.classList.remove('active');
                }
                const authForm = document.getElementById('authForm');
                if (authForm) {
                    authForm.reset();
                }
                updateAuthUI();
            }
        }

        // Обновляем функцию обработки логина
        function handleLogin(username, password) {
            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (!user) {
                if (!users.some(u => u.username === username)) {
                    showError('username', 'Пользователь с таким именем не найден');
                } else {
                    showError('password', 'Неверный пароль');
                }
                return;
            }
            
            if (setCurrentUser(user)) {
                showMessage('success', 'Вход выполнен успешно!');
                const authContainer = document.getElementById('authContainer');
                if (authContainer) {
                    authContainer.classList.remove('active');
                }
                const authForm = document.getElementById('authForm');
                if (authForm) {
                    authForm.reset();
                }
                updateAuthUI();
            }
        }

        // Обновляем функцию выхода
        function logout() {
            try {
                localStorage.removeItem('currentUser');
                updateAuthUI();
                showMessage('success', 'Вы успешно вышли из системы');
                displayStories(); // Обновляем отображение историй
                
                // Очищаем форму авторизации
                const authForm = document.getElementById('authForm');
                if (authForm) {
                    authForm.reset();
                }
                
                // Сбрасываем поиск
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = '';
                    searchStories('');
                }
            } catch (error) {
                console.error('Ошибка при выходе:', error);
                showMessage('error', 'Произошла ошибка при выходе из системы');
            }
        }

        // Вспомогательные функции
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                return date.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Дата неизвестна';
            }
        }

        // Функция обработки ошибок API
        function handleError(error, context = '', defaultMessage = 'Произошла ошибка') {
            // Логирование ошибки
            const errorLog = {
                timestamp: new Date().toISOString(),
                message: error.message || defaultMessage,
                stack: error.stack,
                context: context
            };
            
            console.error('Error:', errorLog);
            
            // Сохранение лога
            try {
                const errorLogs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
                errorLogs.push(errorLog);
                if (errorLogs.length > 50) errorLogs.shift();
                localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
            } catch (e) {
                console.error('Error saving error log:', e);
            }
            
            // Показ сообщения пользователю
            showMessage('error', error.message || defaultMessage);
        }

        // Функция проверки и восстановления данных
        function validateAndRepairData() {
            try {
                // Проверяем и восстанавливаем массив историй
                let stories = getStoriesFromLocalStorage();
                if (!Array.isArray(stories)) {
                    console.warn('Повреждены данные историй, выполняем сброс');
                    stories = [];
                    saveStoriesToLocalStorage(stories);
                }
                
                // Проверяем и восстанавливаем массив пользователей
                let users = getUsers();
                if (!Array.isArray(users)) {
                    console.warn('Повреждены данные пользователей, выполняем сброс');
                    users = [];
                    saveUsers(users);
                }
                
                // Проверяем текущего пользователя
                const currentUser = getCurrentUser();
                if (currentUser && !users.some(u => u.username === currentUser.username)) {
                    console.warn('Сессия пользователя недействительна, выполняем выход');
                    logout();
                }
                
                return true;
            } catch (error) {
                console.error('Ошибка при проверке данных:', error);
                showMessage('error', 'Произошла ошибка при проверке данных приложения');
                return false;
            }
        }

        // Функция логирования ошибок
        function logError(error, context = '') {
            const errorLog = {
                timestamp: new Date().toISOString(),
                message: error.message,
                stack: error.stack,
                context: context
            };
            
            console.error('Logged Error:', errorLog);
            
            try {
                // Сохраняем лог ошибки
                const errorLogs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
                errorLogs.push(errorLog);
                // Храним только последние 50 ошибок
                if (errorLogs.length > 50) {
                    errorLogs.shift();
                }
                localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
            } catch (e) {
                console.error('Ошибка при сохранении лога ошибок:', e);
            }
        }

        // Глобальный обработчик необработанных ошибок
        window.onerror = function(message, source, lineno, colno, error) {
            logError(error || new Error(message), 'Global Error Handler');
            return false;
        };

        // Глобальный обработчик необработанных промисов
        window.addEventListener('unhandledrejection', function(event) {
            logError(event.reason, 'Unhandled Promise Rejection');
        });

        // Добавляем функцию диагностики приложения
        function diagnoseApp() {
            try {
                console.log('Начало диагностики приложения...');
                
                // Проверка хранилища
                const storageStatus = checkBrowserMode();
                console.log('Статус хранилища:', storageStatus);
                
                // Проверка данных
                const stories = getStoriesFromLocalStorage();
                const users = getUsers();
                const currentUser = getCurrentUser();
                
                console.log('Количество историй:', stories.length);
                console.log('Количество пользователей:', users.length);
                console.log('Текущий пользователь:', currentUser ? currentUser.username : 'нет');
                
                // Проверка элементов интерфейса
                const criticalElements = {
                    storiesContainer: document.querySelector('.stories-container'),
                    authButtons: document.querySelector('.auth-buttons'),
                    authInfo: document.querySelector('.auth-info'),
                    storyForm: document.querySelector('.story-form'),
                    messageContainer: document.getElementById('messageContainer')
                };
                
                Object.entries(criticalElements).forEach(([name, element]) => {
                    console.log(`Элемент ${name}:`, element ? 'найден' : 'не найден');
                });
                
                return true;
            } catch (error) {
                console.error('Ошибка при диагностике:', error);
                return false;
            }
        }

        // Функция исправления данных
        function repairData() {
            try {
                console.log('Начало восстановления данных...');
                
                // Проверяем и исправляем истории
                let stories = getStoriesFromLocalStorage();
                if (!Array.isArray(stories)) {
                    console.warn('Исправление структуры историй');
                    stories = [];
                    saveStoriesToLocalStorage(stories);
                }
                
                // Проверяем каждую историю
                stories = stories.filter(story => {
                    if (!story || !story.id || !story.title || !story.text) {
                        console.warn('Удаление поврежденной истории:', story);
                        return false;
                    }
                    // Исправляем отсутствующие поля
                    story.likes = story.likes || 0;
                    story.likedBy = Array.isArray(story.likedBy) ? story.likedBy : [];
                    story.date = story.date || new Date().toISOString();
                    return true;
                });
                
                saveStoriesToLocalStorage(stories);
                
                // Проверяем и исправляем пользователей
                let users = getUsers();
                if (!Array.isArray(users)) {
                    console.warn('Исправление структуры пользователей');
                    users = [];
                    saveUsers(users);
                }
                
                // Проверяем текущего пользователя
                const currentUser = getCurrentUser();
                if (currentUser && !users.some(u => u.username === currentUser.username)) {
                    console.warn('Сброс недействительной сессии');
                    logout();
                }
                
                console.log('Восстановление данных завершено');
                return true;
            } catch (error) {
                console.error('Ошибка при восстановлении данных:', error);
                return false;
            }
        }

        // Функция проверки целостности данных
        function validateStoryData(story) {
            const errors = [];
            
            if (!story.title || story.title.trim().length === 0) {
                errors.push('Отсутствует заголовок истории');
            }
            
            if (!story.text || story.text.trim().length === 0) {
                errors.push('Отсутствует текст истории');
            }
            
            if (!story.authorName) {
                errors.push('Отсутствует автор истории');
            }
            
            if (!story.date) {
                errors.push('Отсутствует дата создания');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Запускаем диагностику при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            if (diagnoseApp()) {
                repairData();
                initializeApp();
            } else {
                showMessage('error', 'Произошла ошибка при запуске приложения');
            }
        });

        // Добавляем функцию для отображения новых историй
        function showNewStories() {
            try {
                const stories = getStoriesFromLocalStorage();
                
                // Сортируем истории по дате (самые новые первые)
                const sortedStories = stories.sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                // Берем только последние 10 историй
                const recentStories = sortedStories.slice(0, 10);
                
                // Отображаем истории с пометкой "Новые истории"
                const storiesContainer = document.querySelector('.stories-container');
                if (!storiesContainer) return;
                
                if (recentStories.length === 0) {
                    storiesContainer.innerHTML = `
                        <div class="no-stories-message">
                            Пока нет новых историй
                        </div>
                    `;
                    return;
                }
                
                // Добавляем заголовок для секции
                storiesContainer.innerHTML = `
                    <div class="stories-section-title">
                        <h2>Новые истории</h2>
                        <span class="stories-count">(последние ${recentStories.length} историй)</span>
                    </div>
                `;
                
                // Отображаем истории
                const storiesHTML = recentStories.map(story => {
                    const currentUser = getCurrentUser();
                    const hasLiked = currentUser && story.likedBy && story.likedBy.includes(currentUser.username);
                    const isAuthor = currentUser && story.authorName === currentUser.username;
                    const timeAgo = getTimeAgo(new Date(story.date));
                    
                    return `
                        <div class="story-container" data-id="${story.id}">
                            <div class="story-header">
                                <h3 class="story-title">${escapeHtml(story.title)}</h3>
                                <span class="story-time">${timeAgo}</span>
                            </div>
                            <p class="story-text">${escapeHtml(story.text)}</p>
                            <div class="story-meta">
                                <span class="story-author">Автор: ${escapeHtml(story.authorName)}</span>
                                <span class="story-date">${formatDate(story.date)}</span>
                            </div>
                            <div class="story-actions">
                                ${currentUser ? `
                                    <button 
                                        class="like-button ${hasLiked ? 'liked' : ''}"
                                        onclick="handleLike(this, '${story.id}')"
                                    >
                                        ${hasLiked ? '❤️' : '🤍'} ${story.likes}
                                    </button>
                                    ${isAuthor ? `
                                        <button 
                                            class="delete-button"
                                            onclick="deleteStory('${story.id}')"
                                        >
                                            🗑️
                                        </button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                storiesContainer.innerHTML += storiesHTML;
                
            } catch (error) {
                console.error('Ошибка при отображении новых историй:', error);
                showMessage('error', 'Произошла ошибка при загрузке новых историй');
            }
        }

        // Функция для отображения времени "прошло с момента публикации"
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days} ${getDeclension(days, ['день', 'дня', 'дней'])} назад`;
            } else if (hours > 0) {
                return `${hours} ${getDeclension(hours, ['час', 'часа', 'часов'])} назад`;
            } else if (minutes > 0) {
                return `${minutes} ${getDeclension(minutes, ['минуту', 'минуты', 'минут'])} назад`;
            } else {
                return 'только что';
            }
        }

        // Вспомогательная функция для склонения слов
        function getDeclension(number, titles) {
            const cases = [2, 0, 1, 1, 1, 2];
            return titles[
                (number % 100 > 4 && number % 100 < 20) ? 2 : 
                cases[(number % 10 < 5) ? number % 10 : 5]
            ];
        }

        // Добавляем обработчик для кнопки "Новые истории"
        document.addEventListener('DOMContentLoaded', () => {
            const newStoriesBtn = document.getElementById('newStoriesBtn');
            if (newStoriesBtn) {
                newStoriesBtn.addEventListener('click', () => {
                    showNewStories();
                    // Подсвечиваем активную кнопку
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    newStoriesBtn.classList.add('active');
                });
            }
        });

        function debounce(func, wait) {
            let timeout;
            const debouncedFunction = function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
            
            debouncedFunction.cancel = function() {
                clearTimeout(timeout);
            };
            
            return debouncedFunction;
        }

        // Добавляем функцию для шаринга
        async function shareStory(button, storyId) {
            try {
                const stories = JSON.parse(localStorage.getItem('stories') || '[]');
                const story = stories.find(s => s.id === storyId);
                
                if (!story) {
                    showMessage('error', 'История не найдена');
                    return;
                }

                const shareData = {
                    title: story.title,
                    text: `${story.text.substring(0, 100)}...`,
                    url: window.location.href
                };

                if (navigator.share && navigator.canShare(shareData)) {
                    // Используем нативный шаринг для мобильных устройств
                    try {
                        await navigator.share(shareData);
                        showMessage('success', 'История успешно отправлена');
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Ошибка при шаринге:', err);
                            showFallbackShare(story);
                        }
                    }
                } else {
                    // Запасной вариант для десктопов
                    showFallbackShare(story);
                }
            } catch (error) {
                console.error('Ошибка при шаринге:', error);
                showMessage('error', 'Ошибка при попытке поделиться историей');
            }
        }

        // Функция для показа запасного варианта шаринга
        function showFallbackShare(story) {
            const shareUrl = window.location.href;
            const shareText = `${story.title}\n\n${story.text.substring(0, 100)}...\n\nЧитать далее: ${shareUrl}`;
            
            // Создаем временный элемент для копирования
            const textarea = document.createElement('textarea');
            textarea.value = shareText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showMessage('success', 'Текст для шаринга скопирован в буфер обмена');
            } catch (err) {
                console.error('Ошибка при копировании:', err);
                showMessage('error', 'Не удалось скопировать текст');
            } finally {
                document.body.removeChild(textarea);
            }
            
            // Показываем модальное окно с соц. сетями
            const shareModal = `
                <div class="share-modal">
                    <div class="share-modal-content">
                        <h3>Поделиться историей</h3>
                        <div class="share-buttons">
                            <a href="https://vk.com/share.php?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(story.title)}" 
                               target="_blank" class="share-button vk">
                                ВКонтакте
                            </a>
                            <a href="https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(story.title)}" 
                               target="_blank" class="share-button telegram">
                                Telegram
                            </a>
                            <button class="share-button copy" onclick="copyToClipboard('${encodeURIComponent(shareText)}')">
                                Копировать ссылку
                            </button>
                        </div>
                        <button class="close-modal" onclick="closeShareModal()">✖</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', shareModal);
        }

        // Функция для копирования в буфер обмена
        function copyToClipboard(text) {
            const decodedText = decodeURIComponent(text);
            navigator.clipboard.writeText(decodedText)
                .then(() => {
                    showMessage('success', 'Скопировано в буфер обмена');
                })
                .catch(err => {
                    console.error('Ошибка при копировании:', err);
                    showMessage('error', 'Не удалось скопировать текст');
                });
        }

        // Функция закрытия модального окна
        function closeShareModal() {
            const modal = document.querySelector('.share-modal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html> 
